<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeTriage | Risk-Aware AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-900 text-slate-100 font-sans antialiased h-screen w-screen overflow-hidden flex" x-data="triageApp()">

    <aside class="w-64 bg-slate-850 border-r border-slate-700 flex flex-col shadow-2xl z-20 shrink-0">
        
        <div class="h-16 flex items-center gap-3 px-6 border-b border-slate-700/50">
            <div class="relative w-8 h-8 flex items-center justify-center">
                <div class="absolute inset-0 bg-brand-500 blur opacity-20 rounded-full"></div>
                <i class="fa-solid fa-heart-pulse text-brand-500 text-xl relative z-10"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight leading-none">SafeTriage</h1>
                <p class="text-[10px] text-slate-400 font-mono mt-0.5">V 1.0.6</p>
            </div>
        </div>

        <nav class="p-4 space-y-1">
            <div class="px-3 py-2 rounded-md text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Workflow</div>
            
            <button type="button" @click="reset()" aria-label="Open upload panel" title="Open upload panel"
                class="w-full px-3 py-2 rounded-md text-sm font-medium flex items-center gap-3 transition-all text-left"
                :class="step === 'upload' ? 'bg-brand-500/10 text-brand-400 border border-brand-500/20' : 'text-slate-400 hover:text-slate-200'">
                <i class="fa-solid fa-cloud-arrow-up w-5 text-center"></i> Upload
            </button>
            
            <div class="w-full px-3 py-2 rounded-md text-sm font-medium flex items-center gap-3 transition-colors cursor-default"
                 :class="step === 'review' ? 'bg-brand-500/10 text-brand-400 border border-brand-500/20' : 'text-slate-600'">
                <i class="fa-solid fa-list-check w-5 text-center"></i> Triage
            </div>
        </nav>

        <div x-show="processed" x-transition class="px-4 mt-6">
            <div class="px-3 py-2 rounded-md text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Export Results</div>
            <div class="space-y-2">
                <button type="button" @click="download('full')" aria-label="Download full dataset" title="Download full dataset" class="w-full flex items-center justify-between px-3 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-slate-300 transition group">
                    <span>Full Dataset</span>
                    <i class="fa-solid fa-download text-slate-500 group-hover:text-white"></i>
                </button>
                <button type="button" @click="download('auto')" aria-label="Download auto-only dataset" title="Download auto-only dataset" class="w-full flex items-center justify-between px-3 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-slate-300 transition group">
                    <span>Auto Only</span>
                    <i class="fa-solid fa-robot text-slate-500 group-hover:text-emerald-400"></i>
                </button>
                <button type="button" @click="download('human')" aria-label="Download human-only dataset" title="Download human-only dataset" class="w-full flex items-center justify-between px-3 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-slate-300 transition group">
                    <span>Human Only</span>
                    <i class="fa-solid fa-user text-slate-500 group-hover:text-amber-400"></i>
                </button>
            </div>
        </div>

        <div class="mt-auto p-4 bg-slate-900 border-t border-slate-700">
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-medium">Automation</span>
                <span class="text-lg font-mono font-bold text-emerald-400" x-text="stats.auto_coverage + '%'">0%</span>
            </div>
            <div class="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden">
                <div class="bg-emerald-500 h-full transition-width duration-700" :style="`width: ${stats.auto_coverage}%`"></div>
            </div>
            <div class="flex justify-between text-[10px] text-slate-500 mt-2 font-mono">
                <span><span x-text="stats.auto">0</span> Auto</span>
                <span><span x-text="stats.human">0</span> Manual</span>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-900">
        
        <header class="h-16 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-850/80 backdrop-blur z-10 shrink-0">
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Current File</span>
                    <span class="text-sm font-medium text-slate-200" x-text="filename || 'No file selected'"></span>
                </div>
                
                <span x-show="processed" class="ml-4 bg-slate-800 text-slate-400 text-xs px-2 py-1 rounded border border-slate-700 uppercase tracking-wide font-bold">
                    <span x-text="riskMode" class="text-brand-400"></span> Mode
                </span>
            </div>
            <div x-show="loading" class="flex items-center gap-2 text-sm text-brand-400 animate-pulse">
                <i class="fa-solid fa-circle-notch fa-spin"></i> Processing...
            </div>
        </header>

        <div x-show="step === 'upload'" class="flex-1 flex flex-col items-center justify-center p-8 overflow-y-auto" x-transition.opacity>
            <div class="max-w-xl w-full">
                
                <div class="w-full h-64 border-2 border-dashed border-slate-600 bg-slate-800/50 rounded-xl flex flex-col items-center justify-center hover:border-brand-500 hover:bg-slate-800 transition cursor-pointer relative group">
                    <input type="file" id="fileInput" accept=".csv" aria-label="Upload dataset CSV" title="Upload dataset CSV (CSV with text column)" @change="handleFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    
                    <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-4 text-slate-300 group-hover:bg-brand-600 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-slate-100">Upload Dataset</h3>
                    <p class="text-slate-400 text-sm mt-1">CSV format â€¢ Max 20MB</p>
                    <p x-show="filename" class="mt-4 text-brand-400 text-sm font-bold bg-brand-500/10 px-3 py-1 rounded-full border border-brand-500/20">
                        <i class="fa-solid fa-check mr-1"></i> <span x-text="filename"></span>
                    </p>
                </div>

                <div class="mt-6 bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-xl">
                    
                    <div x-show="errorMessage" x-transition class="mb-4 p-3 bg-red-500/10 border border-red-500/50 rounded-lg flex items-center gap-3">
                        <i class="fa-solid fa-triangle-exclamation text-red-400"></i>
                        <span class="text-sm text-red-200" x-text="errorMessage"></span>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Risk Tolerance</label>
                            <div class="bg-slate-700/50 p-1 rounded-lg flex shadow-inner">
                                <button type="button" @click="riskMode = 'conservative'" 
                                    :class="riskMode === 'conservative' ? 'bg-brand-600 text-white shadow' : 'text-slate-400 hover:text-white'" 
                                    class="flex-1 py-2 rounded-md text-xs font-medium transition-all" title="Conservative">Conservative</button>
                                <button type="button" @click="riskMode = 'balanced'" 
                                    :class="riskMode === 'balanced' ? 'bg-brand-600 text-white shadow' : 'text-slate-400 hover:text-white'" 
                                    class="flex-1 py-2 rounded-md text-xs font-medium transition-all" title="Balanced">Balanced</button>
                                <button type="button" @click="riskMode = 'aggressive'" 
                                    :class="riskMode === 'aggressive' ? 'bg-brand-600 text-white shadow' : 'text-slate-400 hover:text-white'" 
                                    class="flex-1 py-2 rounded-md text-xs font-medium transition-all" title="Aggressive">Aggressive</button>
                            </div>
                        </div>

                        <div>
                             <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Data Column Name</label>
                             <div class="relative">
                                <i class="fa-solid fa-table-columns absolute left-3 top-3 text-slate-500"></i>
                                <input type="text" id="textColumn" x-model="textColumn" aria-label="Data column name" title="Data column name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 pl-9 text-sm focus:border-brand-500 focus:outline-none text-slate-200" placeholder="e.g. feedback">
                             </div>
                             
                             <button type="button" @click="processData()" :disabled="!file || loading" aria-label="Analyze and triage" title="Analyze and triage" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 rounded shadow-lg transition flex items-center justify-center gap-2">
                                <span x-show="!loading">Analyze & Triage</span>
                                <span x-show="loading"><i class="fa-solid fa-circle-notch fa-spin"></i> Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="step === 'review'" class="flex h-full p-6 gap-6 overflow-hidden" x-cloak>
            
            <div class="flex-1 bg-slate-800 rounded-xl border border-slate-700 flex flex-col overflow-hidden shadow-xl">
                <div class="h-14 border-b border-slate-700 bg-slate-850 flex justify-between items-center px-4 shrink-0">
                    <span class="text-xs font-mono text-slate-500 uppercase tracking-widest">
                        ID: <span x-text="currentTicket?.id" class="text-slate-300"></span>
                    </span>
                    <div class="flex gap-2 items-center">
                         <button type="button" @click="prevTicket()" aria-label="Previous ticket" title="Previous ticket" class="w-8 h-8 rounded hover:bg-slate-700 flex items-center justify-center transition text-slate-400 hover:text-white"><i class="fa-solid fa-chevron-left"></i></button>
                         <span class="text-sm font-mono text-slate-400 w-16 text-center" x-text="`${currentIndex + 1} / ${needsHuman.length}`"></span>
                         <button type="button" @click="nextTicket()" aria-label="Next ticket" title="Next ticket" class="w-8 h-8 rounded hover:bg-slate-700 flex items-center justify-center transition text-slate-400 hover:text-white"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="flex-1 p-8 overflow-y-auto bg-slate-800/50">
                    <p class="text-xl leading-relaxed text-slate-200 font-light" x-text="currentTicket?.text"></p>
                </div>
            </div>

            <div class="w-[380px] flex flex-col gap-4 shrink-0 h-full">
                
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-5 shadow-lg shrink-0">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wide">
                            <i class="fa-solid fa-robot text-brand-500 mr-1"></i> Model Analysis
                        </h3>
                        <span class="text-xs font-mono text-white bg-slate-700 px-2 py-0.5 rounded" x-text="'Risk: ' + currentTicket?.final_risk"></span>
                    </div>

                    <div class="w-full bg-slate-900 rounded-full h-2 overflow-hidden border border-slate-700/50 mb-4">
                        <div class="h-full rounded-full transition-width duration-300"
                             :class="currentTicket?.final_risk > 0.7 ? 'bg-red-500' : (currentTicket?.final_risk > 0.4 ? 'bg-amber-400' : 'bg-emerald-400')"
                             :style="`width: ${(currentTicket?.final_risk || 0) * 100}%`">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-900 p-2 rounded border border-slate-700/50">
                            <span class="text-[10px] uppercase text-slate-500 font-bold block">Intent</span>
                            <span class="text-xs font-medium text-blue-300 truncate block" x-text="currentTicket?.intent"></span>
                        </div>
                        <div class="bg-slate-900 p-2 rounded border border-slate-700/50">
                            <span class="text-[10px] uppercase text-slate-500 font-bold block">Issue</span>
                            <span class="text-xs font-medium text-purple-300 truncate block" x-text="currentTicket?.issue"></span>
                        </div>
                    </div>
                    
                    <button type="button" @click="applyModelSuggestion()" aria-label="Use model suggestions" title="Use model suggestions" class="w-full mt-3 py-2 text-[11px] font-bold uppercase tracking-wide text-brand-400 hover:text-white hover:bg-brand-600 border border-brand-500/20 rounded transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Use Suggestions
                    </button>
                </div>

                <div class="bg-slate-800 rounded-xl border border-slate-700 p-5 shadow-lg flex-1 flex flex-col relative overflow-hidden">
                     <div x-show="flashSuccess" 
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute inset-0 z-50 bg-emerald-500/90 flex items-center justify-center rounded-xl backdrop-blur-sm pointer-events-none">
                        <div class="text-white text-center">
                            <i class="fa-solid fa-check text-4xl mb-2"></i>
                            <p class="font-bold text-sm uppercase tracking-widest">Saved</p>
                        </div>
                    </div>

                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-4">
                        <i class="fa-solid fa-user-pen text-amber-500 mr-1"></i> Human Review
                    </h3>

                    <div class="space-y-4">
                        <div>
                            <label for="correct-intent" class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Correct Intent</label>
                            <div class="relative">
                                <select id="correct-intent" x-model="labels.intent" aria-label="Correct intent" title="Correct intent" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white appearance-none focus:border-amber-500 focus:outline-none cursor-pointer">
                                    <option value="" disabled selected>Select Intent...</option>
                                    <option value="WANTS_INFO">WANTS_INFO</option>
                                    <option value="WANTS_SUPPORT">WANTS_SUPPORT</option>
                                    <option value="WANTS_ACTION">WANTS_ACTION</option>
                                </select>
                                <i class="fa-solid fa-caret-down absolute right-3 top-3 text-slate-500 pointer-events-none text-xs"></i>
                            </div>
                        </div>
                        <div>
                            <label for="correct-issue" class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Correct Issue</label>
                            <div class="relative">
                                <select id="correct-issue" x-model="labels.issue" aria-label="Correct issue" title="Correct issue" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white appearance-none focus:border-amber-500 focus:outline-none cursor-pointer">
                                    <option value="" disabled selected>Select Issue...</option>
                                    <option value="PAYMENT_PROBLEM">PAYMENT_PROBLEM</option>
                                    <option value="DATA_LOSS">DATA_LOSS</option>
                                    <option value="ACCOUNT_ACCESS">ACCOUNT_ACCESS</option>
                                    <option value="SOFTWARE_BUG">SOFTWARE_BUG</option>
                                    <option value="CONNECTIVITY_ISSUE">CONNECTIVITY_ISSUE</option>
                                    <option value="HARDWARE_FAILURE">HARDWARE_FAILURE</option>
                                    <option value="DELIVERY_PROBLEM">DELIVERY_PROBLEM</option>
                                    <option value="GENERAL_SUPPORT">GENERAL_SUPPORT</option>
                                </select>
                                <i class="fa-solid fa-caret-down absolute right-3 top-3 text-slate-500 pointer-events-none text-xs"></i>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 p-3 bg-slate-900/50 rounded border border-slate-700/50 cursor-pointer hover:bg-slate-900 transition" @click="labels.safe = !labels.safe">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="safe" x-model="labels.safe" aria-label="Safe for Automation" title="Safe for Automation" class="peer h-4 w-4 cursor-pointer appearance-none rounded border border-slate-500 checked:bg-emerald-500 checked:border-emerald-500 transition-all">
                                <i class="fa-solid fa-check text-white absolute left-0.5 top-0.5 text-[10px] opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                            </div>
                            <label for="safe" class="text-xs text-slate-300 select-none cursor-pointer font-medium">Safe for Automation</label>
                        </div>
                    </div>

                    <div class="mt-auto pt-4">
                        <button @click="saveAndNext()" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 rounded shadow-lg shadow-brand-900/40 transition active:scale-95 flex items-center justify-center gap-2">
                            <span>Save & Next</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        
                        <button @click="exportLabels()" class="w-full mt-3 text-[10px] text-slate-500 hover:text-white hover:underline transition text-center" x-show="pendingLabels.length > 0">
                            Export <span x-text="pendingLabels.length"></span> Pending
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>